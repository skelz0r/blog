<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>Skelz0r's blog | üëæ Debugging Capybara in headless mode</title>
  <meta name="description" content="How I manage to find the problem on Github Actions thanks to remote debugging" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta property="og:title" content="üëæ Debugging Capybara in headless mode" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://blog.skelz0r.fr/posts/debugging-capybara-headless-driver" />
  <meta property="og:description" content="How I manage to find the problem on Github Actions thanks to remote debugging" />
  <meta property="og:site_name" content="Skelz0r's blog" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:url" content="https://blog.skelz0r.fr/posts/debugging-capybara-headless-driver" />
  <meta name="twitter:title" content="üëæ Debugging Capybara in headless mode" />
  <meta name="twitter:description" content="How I manage to find the problem on Github Actions thanks to remote debugging" />

   
  <meta
    property="og:image"
    content="https://blog.skelz0r.fr/assets/debugging-capybara-headless-driver/meta-bbc8533a47531701becd6fd8a5cd09773e62ffc84da7d9e355bd2da9346539ce.jpg"
  />
  <meta
    name="twitter:image"
    content="https://blog.skelz0r.fr/assets/debugging-capybara-headless-driver/meta-bbc8533a47531701becd6fd8a5cd09773e62ffc84da7d9e355bd2da9346539ce.jpg"
  />
   

  <link
    href="https://blog.skelz0r.fr/feed.xml"
    type="application/rss+xml"
    rel="alternate"
    title="Skelz0r's blog Last 10 blog posts"
  />

    
  <link
    rel="icon"
    type="image/x-icon"
    href="/assets/favicon-light-2fc9a2d675e2305136284777759d667667b29d7a63b169fd502e95388eae284a.ico"
  />
  <link
    rel="apple-touch-icon"
    href="/assets/apple-touch-icon-light-d2652717b4f54e36ea5cc78c6fc16f3f1fafcbb9d4357a62f9f4c2982cead96c.png"
  />
  <link
    rel="stylesheet"
    type="text/css"
    title="light"
    id="light"
    href="/assets/light-bdd7976866160e725546b7e26658562dab5fcecabcbbbc8e365d4a50ab15f308.css"
  />
  <link
    rel="stylesheet"
    type="text/css"
    title="dark"
    id="dark"
    href="/assets/dark-8d74db733f1fcae5f78c1c29ced43fe227351de91bb8f087086eea8748da90bb.css"
    disabled="true"
  />
   

  <link rel="webmention" href="https://webmention.io/username/webmention" />
  <link rel="pingback" href="https://webmention.io/username/xmlrpc" />
</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="Skelz0r's blog">
    ‚úèÔ∏è Skelz0r's blog
  </a>
  <ul class="header-links">
    
    
      <li>
        <a href="https://twitter.com/sklzr" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/skelz0r" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="/feed.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a onclick="toggle()" title="Toggle Theme">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-theme">
  <use href="/assets/theme-66869e0bf8dab34bae1c86bda400327b772e0be69e8dc28d3ede896e771320ed.svg#icon-theme" xlink:href="/assets/theme-66869e0bf8dab34bae1c86bda400327b772e0be69e8dc28d3ede896e771320ed.svg#icon-theme"></use>
</svg>

        </a>
      </li>
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>üëæ Debugging Capybara in headless mode</h1>
            <p>How I manage to find the problem on Github Actions thanks to remote debugging</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    January 16, 2020
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      5 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/english" title="See all posts with tag 'EN'">EN</a>
    
      
      <a href="/tag/rails" title="See all posts with tag 'Ruby on Rails'">Ruby on Rails</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p>Github provides since <a href="https://github.blog/2019-08-08-github-actions-now-supports-ci-cd/">august
2019</a> a new
way to orchestrate any workflow, based on any event : Github Actions. A lot of developers
migrates to this for their CI, because it‚Äôs (almost) free and fully integrated
with github (no need to register to a new service for CI !).</p>

<p>The setup for a Ruby on Rails app with some features tests based on Capybara
and some javascript is quite simple with the <a href="https://github.com/twalpole/apparition">apparition gem</a> (it works
out of a box, without any specific configurations).</p>

<p>You can find an example of a working CI configuration
<a href="https://gist.github.com/skelz0r/1edd3b9aef22fde307ed2031684e14be">here</a> (this
example use some caching, rubocop and brakeman).</p>

<p>One day, my CI stopped working : I had some js features tests which failed ( but
not on my computer ). I was like ‚Äú Damn, remote debugging headless chrome tests
seems to be pretty hard üò¨‚Äù.</p>

<p>And yes, it was not an easy process üôÑ‚Ä¶ that‚Äôs why I wrote this post today.</p>

<h2 id="finding-a-tool-to-reproduce-the-fail-scenario">Finding a tool to reproduce the fail scenario</h2>

<p>In my computer, failing tests are green, so I have to find a way to reproduce it.</p>

<p>I find a tool named <a href="https://github.com/nektos/act">act</a>, which seems
to be a great fit for my needs : it uses Docker (like Github Actions) and read
Github Actions configuration files in <code class="highlighter-rouge">.github/workflows</code> to reproduce the exact
behaviour of github actions.</p>

<p>However, I had multiple issues with it üòï</p>
<ol>
  <li>First, <a href="https://github.com/nektos/act/issues/311">I does not resolve tag well</a>, and failed on
my second step.</li>
  <li>Second, I had an issue on a <a href="https://github.com/nektos/act/issues/265">env
variable which was not set</a></li>
  <li>And the last one which led me to seek to an another solution :</li>
</ol>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="o">[</span>Rails tests/RSpec]   ‚ùì  ::group::Installing Bundler
| Using Bundler 2.1.4 from Gemfile.lock BUNDLED WITH 2.1.4
| <span class="o">[</span><span class="nb">command</span><span class="o">]</span>/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/gem <span class="nb">install </span>bundler <span class="nt">-v</span> 2.1.4 <span class="nt">--no-document</span>
| /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/yaml.rb:3: warning: It seems your ruby installation is missing psych <span class="o">(</span><span class="k">for </span>YAML output<span class="o">)</span><span class="nb">.</span>
| To eliminate this warning, please <span class="nb">install </span>libyaml and reinstall your ruby.
| /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:92:in <span class="sb">`</span>require<span class="s1">': libyaml-0.so.2: cannot open shared object file: No such file or directory - /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/x86_64-linux/psych.so (LoadError)
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:92:in `require'</span>
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/psych.rb:13:in <span class="sb">`</span>&lt;top <span class="o">(</span>required<span class="o">)&gt;</span><span class="s1">'
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:92:in `require'</span>
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:92:in <span class="sb">`</span>require<span class="s1">'
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/yaml.rb:4:in `&lt;top (required)&gt;'</span>
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:92:in <span class="sb">`</span>require<span class="s1">'
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/core_ext/kernel_require.rb:92:in `require'</span>
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems.rb:712:in <span class="sb">`</span>load_yaml<span class="s1">'
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/config_file.rb:332:in `load_file'</span>
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/config_file.rb:182:in <span class="sb">`</span>initialize<span class="s1">'
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/gem_runner.rb:79:in `new'</span>
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/gem_runner.rb:79:in <span class="sb">`</span>do_configuration<span class="s1">'
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/lib/ruby/2.7.0/rubygems/gem_runner.rb:44:in `run'</span>
|       from /opt/hostedtoolcache/Ruby/2.7.2/x64/bin/gem:21:in <span class="sb">`</span>&lt;main&gt;<span class="s1">'
| Took   0.10 seconds
[Rails tests/RSpec]   ‚ùì  ::endgroup::
[Rails tests/RSpec]   ‚ùó  ::error::The process '</span>/opt/hostedtoolcache/Ruby/2.7.2/x64/bin/gem<span class="s1">' failed with exit code 1
[Rails tests/RSpec]   ‚ùå  Failure - Setup ruby</span></code></pre></figure>

<p>The (painful) error:</p>

<p><code class="highlighter-rouge">To eliminate this warning, please install libyaml and reinstall your ruby.</code></p>

<p>My reaction üëá</p>

<p><img src="/assets/no-a37653186a9d2162161f556687466712b9e57c49953e43c7f5c415cec083000b.jpg" /></p>

<p>I gave up and tried something else, which I knew will be more tricky : remote debugging üëæ</p>

<h3 id="remote-debugging">Remote debugging</h3>

<p>I found a github action that can create a tmate session on the host system :
<a href="https://github.com/mxschmitt/action-tmate">action-tmate</a></p>

<p>All you have to do it‚Äôs to put the step just before the rspec step, push on
github, and connect to a ssh session.</p>

<p>When you open the action, you‚Äôll see the information to connect to this
session:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">Created new session successfully
ssh vJg3mMskB7WnnLfYHRtCDFRpE@nyc1.tmate.io

https://tmate.io/t/vJg3mMskB7WnnLfYHRtCDFRpE</code></pre></figure>

<p>FYI, It will loop until you (or Github) decide to stop the container.</p>

<p>In my case, I had to see what‚Äôs going on my headless browser.
Thanks to apparition, it‚Äôs possible to <a href="https://github.com/twalpole/apparition#taking-screenshots-with-some-extensions">takes
screenshots</a>,
so I put this line just before one of my failing assertion:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/features/whatever_spec.rb</span>
<span class="n">it</span> <span class="s1">'does stuff'</span><span class="p">,</span> <span class="ss">js: </span><span class="kp">true</span> <span class="k">do</span>
  <span class="n">perform_some_actions</span>

  <span class="n">save_screenshot</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'screenshot.png'</span><span class="p">))</span>

  <span class="n">perform_assertions</span>
<span class="k">end</span></code></pre></figure>

<p>All I need to do is to connect to the remote session, run the failing test
and get the screenshot (thanks to <a href="https://transfer.sh/">transfer.sh</a>, <code class="highlighter-rouge">scp</code> and
<code class="highlighter-rouge">rsync</code> does not work on tmate.io)</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">ssh vJg3mMskB7WnnLfYHRtCDFRpE@nyc1.tmate.io

<span class="c"># On the remote session</span>
bundle <span class="nb">exec </span>rspec spec/features/whatever_spec.rb
curl <span class="nt">--upload-file</span> screenshot.png https://transfer.sh/screenshot.png</code></pre></figure>

<p>Here is my remote screenshot üëá
<img src="/assets/debugging-capybara-headless-driver/remote-screenshot-7bfd525576bb0abb9dae76b3c165dd10553b9a497f75221a71289d3921c0687e.png" /></p>

<p>On this test, one of my <code class="highlighter-rouge">perform_some_actions</code> is to toggle the content by
clicking on the element (example below, same screenshot but on my computer)</p>

<p><img src="/assets/debugging-capybara-headless-driver/local-screenshot-44841ae08112c3bf1561aea0f43bd736783b2b7c1e37cd60d3e4f4b2b2efc6a1.png" /></p>

<p>Clearly the action of toggling the content does not work on the CI.</p>

<p>My clicking action from my capybara test:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">find</span><span class="p">(</span><span class="s2">"#request_</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">).</span><span class="nf">click</span></code></pre></figure>

<p>And my actual DOM:</p>

<figure class="highlight"><pre><code class="language-erb" data-lang="erb"><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">dom_id</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">class=</span><span class="s">"card padding-small"</span> <span class="na">data-controller=</span><span class="s">"content-toggle"</span> <span class="na">data-content-toggle-toggle-class=</span><span class="s">"hidden"</span> <span class="na">data-content-toggle-icon=</span><span class="s">"chevron-bottom"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"block lg:flex mb-4 items-center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"w-full text-center lg:text-left lg:w-2/3"</span> <span class="na">data-action=</span><span class="s">"click-&gt;content-toggle#toggle"</span><span class="nt">&gt;</span>
      Some content
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"w-full text-center lg:w-1/3 lg:text-right"</span> <span class="na">data-action=</span><span class="s">"click-&gt;content-toggle#toggle"</span><span class="nt">&gt;</span>
      Another content
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre></figure>

<p>I use <a href="https://stimulus.hotwire.dev/">StimulusJS</a> to trigger some javascript
(rails way!) (and some <a href="https://tailwindcss.com/">Tailwind CSS</a>).</p>

<p>I suspect that
Capybara tries to click on the div, but not on the 2 last divs which triggers
the actual toggle (divs with <code class="highlighter-rouge">data-action="click-&gt;content-toggle#toggle"</code>)</p>

<p>I tried to harden my clicking action by targetting the exact div like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">all</span><span class="p">(</span><span class="s2">"#request_</span><span class="si">#{</span><span class="n">request</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> [data-action=</span><span class="se">\"</span><span class="s2">click-&gt;content-toggle#toggle</span><span class="se">\"</span><span class="s2">]"</span><span class="p">).</span><span class="nf">first</span><span class="p">.</span><span class="nf">click</span></code></pre></figure>

<p>I pushed on my debugging branch to trigger the build with my tmate action
enabled (in order to run this test exactly) and guess what : it worked üôåüéâ</p>

<h2 id="conclusion">Conclusion</h2>

<ol>
  <li><a href="https://github.com/nektos/act">act</a> seems promising, I‚Äôll definitely watch
the evolution (be able to debug actions in local is definitely a nice to
have!)</li>
  <li>Take screenshots and upload them in order to inspect exactly what‚Äôs happen on
your remote session, transfer.sh is a great tool for this</li>
</ol>

<p>Have a pleasant day üôÉ</p>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/intent/tweet?text=%F0%9F%91%BE+Debugging+Capybara+in+headless+mode%20-%20https://blog.skelz0r.fr/posts/debugging-capybara-headless-driver%20by%20@sklzr" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
          </div>

          
        </article>
        <footer
  class="footer scrollappear"
>
  <p>
    For any comments or thoughts, please reach me on twitter
    <a href="https://twitter.com/sklzr" rel="me">@sklzr</a> ‚úåÔ∏è
  </p>
   
  <p>
    <small>
      This blog uses basic analytics through GoatCounter, which does not track
      any personal data. You can check web analytics by following
      <a href="https://skelz0r-blog.goatcounter.com/">this link</a>.
    </small>
  </p>
  
</footer>

      </div>
    </div>
  </main>
  


<script data-goatcounter="https://skelz0r-blog.goatcounter.com/count"
        async src="//gc.zgo.at/count.js">
</script>


<script src="/assets/vendor-130c9c254effc51f3283620bc635851da7b99c20901216948f11ba72ee13317f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


  <script src="/assets/themetoggle-df0d3d73164dc26dffbd630182ae4d0dfa7bee6b694a2b5d565d73595b582bbf.js" type="text/javascript"></script>


</body>
</html>
